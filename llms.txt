# @makebelieve21213-packages/logger - Документация для ИИ

## Краткое описание

Универсальный ESM пакет логирования для микросервисов NestJS на базе Winston. Использует Winston для записи логов в файлы с ротацией и опциональной отправкой в Logstash. Полностью совместим с экосистемой NestJS. **Transient Scope** - каждый сервис получает свой экземпляр с индивидуальным контекстом.

## Архитектура

Пакет предоставляет:
- **LoggerModule** - глобальный NestJS модуль для регистрации
- **LoggerService** - сервис логирования с Transient scope

## Структура пакета

```
src/
├── configs/
│   └── winston.config.ts         # Конфигурация Winston транспортов
├── errors/
│   └── logger.error.ts           # Кастомная ошибка LoggerError
├── interfaces/
│   └── logger.interface.ts       # Интерфейс Logger (расширяет NestJS)
├── main/
│   ├── logger.module.ts          # NestJS модуль (Global)
│   └── logger.service.ts         # Основной сервис логирования (Transient)
├── types/
│   └── logger.types.ts           # TypeScript типы и интерфейсы
├── utils/
│   ├── constants.ts              # Константы
│   ├── directory.ts              # Утилиты для работы с директориями
│   └── formatters.ts             # Форматтеры для консоли и файлов
└── index.ts                      # Экспорты пакета
```

## Основные компоненты

### LoggerService (Transient Scope)

**Scope.TRANSIENT** - каждый сервис получает свой экземпляр с индивидуальным контекстом.

Методы:
- `log(message, context?)` - info логи (консоль + файл)
- `error(message, trace?, context?)` - ошибки (консоль + файл + Logstash)
- `warn(message, context?)` - предупреждения (консоль + файл)
- `debug(message, context?)` - отладка (только консоль, НЕ в файл)
- `verbose(message, context?)` - alias для `log()`
- `setContext(context)` - установка контекста
- `close()` - graceful shutdown
- `onModuleDestroy()` - закрытие транспортов

Winston logger создается автоматически в конструкторе. Graceful shutdown через `onModuleDestroy()` закрывает все транспорты.

### LoggerModule (Global Module)

Помечен как `@Global()` - доступен во всех модулях без повторного импорта.

Метод инициализации:
- `forRootAsync(options)` - асинхронная инициализация через useFactory

Параметры:
- `useFactory: (deps) => LoggerConfig` - фабрика для создания конфигурации
- `inject?: InjectionToken[]` - зависимости для инжекции в useFactory
- `imports?: Module[]` - дополнительные модули для DI

Опции (возвращаемые useFactory):
- `serviceName: string` - имя сервиса (обязательно)
- `maxFiles?: number` - дней хранения (по умолчанию 30)
- `maxLinesPerFile?: number` - строк в файле (по умолчанию 10000)
- `logstashHost?: string` - хост Logstash (опционально)
- `logstashPort?: number` - порт Logstash (опционально)
- `logDir?: string` - директория для логов (абсолютный или относительный путь)

Экспортирует: `LoggerService`

### Winston транспорты

- **Console** - цветной вывод в консоль (все уровни)
- **DailyRotateFile** - запись в файл с ротацией
  - Ротация по дате (ежедневно) и по размеру (maxLinesPerFile)
  - Путь: `{logDir}/{serviceName}/{DATE}.log`
  - Уровень: `info` (логирует error, warn, info; НЕ логирует debug)
- **Logstash** (опционально) - отправка логов в Logstash через TCP
  - Только для уровня `error`

## Уровни логирования

- `error` → консоль (красный) + файл + Logstash (если настроен)
- `warn` → консоль (желтый) + файл
- `log` (info) → консоль (зеленый) + файл
- `debug` → только консоль (голубой), **НЕ в файл**
- `verbose` → alias для `log()` (совместимость с NestJS)

## Структура файлов логов

- Путь по умолчанию: `process.cwd()/logs/{serviceName}/{YYYY-MM-DD}.log`
- Кастомный путь: `{logDir}/{serviceName}/{YYYY-MM-DD}.log`
- Автоматическое создание директорий
- Один файл на день для всех уровней (error, warn, info)
- Debug логи НЕ записываются в файл

Формат JSON в файлах:
```json
{
  "timestamp": "2024-01-15 10:30:45",
  "level": "error",
  "service": "api-service",
  "context": "UserService",
  "message": "Failed to create user",
  "trace": "Error: Validation failed..."
}
```

## Использование

### Регистрация в AppModule

```typescript
import { Module } from '@nestjs/common';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { LoggerModule } from '@makebelieve21213-packages/logger';

@Module({
  imports: [
    ConfigModule.forRoot({ isGlobal: true }),
    LoggerModule.forRootAsync<[ConfigService]>({
      useFactory: (configService: ConfigService) => ({
        serviceName: configService.get('SERVICE_NAME') || 'unknown-service',
        maxFiles: 30,
        maxLinesPerFile: 10000,
        logstashHost: configService.get('LOGSTASH_HOST'),
        logstashPort: configService.get('LOGSTASH_PORT')
          ? parseInt(configService.get('LOGSTASH_PORT'))
          : undefined,
        logDir: configService.get('LOGGER_LOG_DIR'),
      }),
      inject: [ConfigService],
    }),
  ],
})
export class AppModule {}
```

### Инжекция в сервис

```typescript
import { Injectable } from '@nestjs/common';
import LoggerService from '@makebelieve21213-packages/logger';

@Injectable()
export default class MyService {
  constructor(private readonly logger: LoggerService) {
    this.logger.setContext('MyService');
  }

  async doSomething() {
    this.logger.log('Starting operation');
    try {
      // operation
      this.logger.log('Operation completed');
    } catch (error) {
      this.logger.error('Operation failed', error.stack);
      throw error;
    }
  }
}
```

### Использование в main.ts

```typescript
import { NestFactory } from '@nestjs/core';
import LoggerService from '@makebelieve21213-packages/logger';
import AppModule from './app/app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule, {
    bufferLogs: true,
  });

  const logger = app.get(LoggerService);
  logger.setContext('Bootstrap');
  app.useLogger(logger);

  await app.listen(3000);
  logger.log('Application is running');
}

bootstrap();
```

## Важные детали реализации

### Transient Scope
- Каждый сервис получает свой экземпляр `LoggerService`
- Индивидуальный контекст для каждого сервиса
- Winston logger создается внутри каждого экземпляра

### Инициализация
- Winston logger создается автоматически в конструкторе `LoggerService`
- Logger готов к использованию сразу после создания экземпляра

### Graceful Shutdown
- `onModuleDestroy()` закрывает все транспорты Winston
- Важно для корректного закрытия TCP соединений (Logstash) и файловых дескрипторов

### Ротация логов
- По дате: каждый день создается новый файл
- По размеру: новый файл создается каждые `maxLinesPerFile` строк
- Автоочистка: старые файлы удаляются через `maxFiles` дней

## Экспорты (index.ts)

Пакет экспортирует:
- `LoggerModule` (default export)
- `LoggerService` (default export)
- `LoggerConfig` (тип)
- `Logger` (интерфейс)
- `LoggerError` (класс ошибки)

## Типичные сценарии использования

### Базовое использование
1. Импортировать `LoggerModule.forRootAsync()` в AppModule
2. Инжектировать `LoggerService` в сервисы
3. Вызывать `setContext()` в конструкторе
4. Использовать методы логирования

### С Logstash
1. Указать `logstashHost` и `logstashPort` в конфигурации
2. Логи уровня `error` автоматически отправляются в Logstash

### С кастомной директорией логов
1. Указать `logDir` в конфигурации (абсолютный или относительный путь)
2. Логи будут создаваться в указанной директории

## Важные замечания

1. **Transient Scope**: Каждый сервис получает свой экземпляр логгера
2. **Debug логи**: Не записываются в файл, только в консоль
3. **Logstash**: Только логи уровня `error` отправляются в Logstash
4. **Graceful shutdown**: Автоматически закрывает все транспорты при остановке
5. **Контекст**: Устанавливается через `setContext()` или передается в методы
6. **Ротация**: Автоматическая по дате и размеру файла
7. **Разделение по сервисам**: Каждый сервис пишет в свою директорию

## Зависимости

- `winston` - логгер
- `winston-daily-rotate-file` - ротация файлов
- `winston-logstash` - отправка в Logstash
- `@nestjs/common` - NestJS decorators и интерфейсы
- `reflect-metadata` - для декораторов

### Peer
- `@nestjs/common` ^11.0.0
- `reflect-metadata` ^0.1.13 || ^0.2.0
- `rxjs` ^7.0.0
